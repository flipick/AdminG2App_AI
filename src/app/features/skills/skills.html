<div class="page-container">
  <!-- Header -->
  <header class="page-header">
    <!-- Left Side: Title & Subtitle -->
    <div>
      <h1 class="heading-txt">Skills Framework</h1>
      <p class="content-text">Define and manage organizational skills and competencies</p>
    </div>
    <!-- Right Side: Back Button -->
    <div class="ml-auto">
    </div>
  </header>

  @if(permissions.showSkillSettings) {
    <div class="ml-auto flex items-center gap-2">
      <div class="inline-flex justify-center items-center rounded-lg border border-primary-500 *:text-sm *:px-3 *:py-1.5">
        <button 
          class="rounded-l-lg font-medium transition-all"
          [ngClass]="showSkillSettings ? 'bg-gray-100 text-gray-700 cursor-pointer' : 'font-semibold bg-primary-500 text-white cursor-default'"
          (click)="showSkillSettings = false">
          Skills
        </button>
        <button 
          class="rounded-r-lg font-medium transition-all"
          [ngClass]="showSkillSettings ? 'font-semibold bg-primary-500 text-white cursor-default' : 'bg-gray-100 text-gray-700 cursor-pointer'"
          (click)="toggleSkillSettings()">
          Skill Settings
        </button>
      </div>


      <button (click)="onRestAllSelection()" class="btn-outline w-full lg:w-auto">
        Reset
      </button>
    </div>
  }

  @if(!showSkillSettings) {
    <section class="page-content">
      <!-- Filters -->
      <div class="flex flex-wrap items-end gap-4 bg-white p-4 rounded-lg shadow-sm">
        <!-- Tenant -->
        <div class="grow shrink-0 basis-[0%] w-full max-w-full">
          <label for="tenant" class="form-label">Tenant</label>

          <!-- Show dropdown if not disabled -->
          <ng-container *ngIf="!isDropdownDisabled; else tenantReadonly">
            <select id="tenant" (change)="onTenantChange($event)" class="form-select w-full"
              [disabled]="!permissions.showTenantDropdown">
              <option value="">All</option>
              <option *ngFor="let tenant of tenantlist" [value]="tenant.tenantId"
                [selected]="tenant.tenantId.toString() === selectedTenantId">
                {{ tenant.tenantName }}
              </option>
            </select>
          </ng-container>

          <!-- Read-only input when disabled -->
          <ng-template #tenantReadonly>
            <input type="text" class="form-input w-full cursor-default" [value]="selectedTenant" readonly />
          </ng-template>
        </div>

        <!-- Sector -->
        <div class="grow shrink-0 basis-[0%] w-full max-w-full">
          <label for="sector" class="form-label">Sector</label>

          <ng-container *ngIf="!isDropdownDisabled; else sectorReadonly">
            <select id="sector" (change)="onSectorChange($event)" class="form-select w-full">
              <option value="">All</option>
              <option *ngFor="let sector of sectorData" [value]="sector.sectorId">
                {{ sector.sectorName }}
              </option>
            </select>
          </ng-container>

          <ng-template #sectorReadonly>
            <input type="text" class="form-input w-full cursor-default" [value]="selectedSector" readonly />
          </ng-template>
        </div>

        <!-- Track -->
        <div class="grow shrink-0 basis-[0%] w-full max-w-full">
          <label for="track" class="form-label">Track</label>

          <ng-container *ngIf="!isDropdownDisabled; else trackReadonly">
            <select id="track" (change)="onTrackChange($event)" class="form-select w-full">
              <option value="">All</option>
              <option *ngFor="let track of trackData" [value]="track.trackId">
                {{ track.trackName }}
              </option>
            </select>
          </ng-container>

          <ng-template #trackReadonly>
            <input type="text" class="form-input w-full cursor-default" [value]="selectedTrack" readonly />
          </ng-template>
        </div>

        <!-- Role remains unchanged -->
        @if(groupedKeyData.length > 0) {
        <div class="grow shrink-0 basis-[0%] w-full max-w-full">
          <label class="block mb-2 text-sm text-gray-900">Role</label>
          <span [ngClass]="{'disabled-span': isDropdownDisabled}" #roleSpan
            class="form-input cursor-default w-full whitespace-nowrap">{{selectedRole}}</span>
        </div>
        }

        <!-- Apply Button -->
        <div>
          <button (click)="onApplyFilter()" class="btn-outline w-full lg:w-auto">
            Apply
          </button>
        </div>
        <!-- Assign Button -->
        @if(hasSelection && selectedTenantId) {
        <div>
          <button (click)="onAssignToTenant()" class="btn-primary w-full" *ngIf="groupedKeyData.length == 0">
            Assign to Tenant
          </button>
        </div>
        } @else {

        }
      </div>
      <!-- Role Cards -->
      @if(roleData.length > 0 && groupedKeyData.length === 0) {
      <section class="mb-6">
        <div class="grid md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-4">
          @for(roles of roleData; track $index) {
          <div
            class="group flex flex-col justify-between relative bg-white border border-transparent p-4 has-checked:bg-white/80 has-checked:border-primary-500 rounded-xl shadow overflow-hidden">
            <h3 class="text-lg leading-5 font-medium text-gray-800 group-has-checked:text-primary-500 mb-2">{{
              roles.jobRoleName }}</h3>
            <p class="text-sm text-gray-500 group-has-checked:text-primary-400 mt-auto line-clamp-2"
              [attr.title]="roles.jobRoleDescription || ''">
              {{ roles.jobRoleDescription }}
            </p>
            @if(selectedTenantId) {
            <div class="mt-4 flex items-center gap-2">
              <label title="Select skill"
                class="relative flex justify-center items-center gap-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg hover:border-primary-500 hover:text-primary-500 focus:text-primary-500 focus:ring-primary-500 focus:border-primary-500 has-checked:bg-primary-50 has-checked:border-primary-500 has-checked:text-primary-500 w-8 h-8 cursor-pointer">
                <input type="checkbox" [(ngModel)]="roles.isChecked" (change)="onCheckboxChange($event, roles)"
                  class="sr-only" />
                @if (roles.isChecked) {
                <!-- <span>Selected</span> -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 stroke-primary-500" fill="none"
                  viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                } @else {
                <!-- <span>Select</span> -->
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 stroke-gray-500">
                  <g id="Edit / Add_Plus">
                    <path id="Vector" d="M6 12H12M12 12H18M12 12V18M12 12V6" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"></path>
                  </g>
                </svg>
                }
              </label>
              <div class="ml-auto flex items-center gap-2">
                @if(roles.isCheckedAsignToTenant) {
                <button (click)="editSkills(roles)"
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg hover:border-indigo-500 hover:text-indigo-500 focus:text-indigo-500 focus:ring-indigo-500 focus:border-indigo-500 py-1 px-4 cursor-pointer">
                  Edit
                </button>
                }
              </div>
            </div>
            }
          </div>
          }
        </div>
      </section>
      }

      <!-- Grouped Key Tasks -->
      @if(groupedKeyData.length > 0) {
      <section class="grid gap-4">
        <div class="space-y-4">
          @for (taskGroup of groupedKeyData; track taskGroup) {
          <div class="space-y-4 bg-white rounded-lg shadow p-4">
            <!-- Header -->
            <div class="grid grid-cols-[1fr_auto] items-center gap-4 border-b border-gray-200 pb-3">
              <!-- Editable Title -->
              <h3 class="font-semibold text-gray-800">
                <span [attr.oldValue]="taskGroup.criticalWorkFunction"
                  [attr.contenteditable]="taskGroup.isEditing ? 'true' : null"
                  class="px-2 py-1 rounded w-full text-gray-800" 
                  (blur)="onCwfChange(taskGroup, $event)">
                  {{ taskGroup.criticalWorkFunction }}
                </span>
              </h3>

              <button #editBtn class="btn-outline btn-sm" (click)="toggleEdit(taskGroup)">
                {{ taskGroup.isEditing ? 'Update' : 'Edit' }}
              </button>
            </div>

            <ul class="grid gap-2">
              @for (task of taskGroup.tasks; track task; let i = $index) {
              <li class="grid grid-cols-[1fr_auto] gap-2 items-stretch bg-white rounded-lg">
                <span [attr.contenteditable]="taskGroup.isEditing ? 'true' : null" 
                  (blur)="onKeyTaskEdit(task, $event)"
                  [attr.oldValue]="task.keyTaskSkill" class="block">
                  {{ task.keyTaskSkill }}
                </span>

                @if (task.isNew) {
                <button class="btn-outline border-red-300 text-red-500 hover:bg-red-500 hover:text-white"
                  (click)="removeTask(taskGroup, i)"> Remove
                </button>
                }
              </li>
              }
            </ul>

            @if (taskGroup.isEditing) {
            <div>
              <button class="btn-outline" (click)="addTask(taskGroup)">Add Key Task</button>
            </div>

            }
          </div>
          }
        </div>
        <div>
          <button class="btn-outline" (click)="addCWFKeyTask()">Add New</button>
        </div>
        <!-- Core Skills -->
        @if (coreSkills.length > 0) {
        <div class="grid gap-2 bg-white p-4 rounded-lg shadow-sm">
          <div class="flex justify-between items-center border-b border-gray-300 pb-2">
            <h3 class="ftext-lg font-bold text-gray-700">Skill Gaps (Core Skills)</h3>
            <button class="btn-outline btn-sm" (click)="toggleCoreEdit()">
              {{ isCoreEditing ? 'Update' : 'Edit' }}
            </button>
          </div>

          <div class="grid gap-2">
            @for (skill of coreSkills; track skill) {
            <div class="grid grid-cols-[1fr_150px_auto] gap-2 items-stretch bg-white rounded-lg">

              <!-- Editable Core Skill -->
              <span [attr.contenteditable]="isCoreEditing ? 'true' : null" 
                [attr.oldValue]="skill.oldValue" class="block"
                (blur)="onCoreSkillChange(skill, $event);skill.isEdited = true;">
                {{ skill.coreSkill }}
              </span>

              @if (isCoreEditing) {
              <select [(ngModel)]="skill.proficiencyLevel" class="form-select" (change)="onCoreProficiencyChange(skill)">
                @for (level of [1,2,3,4,5]; track level) {
                <option [value]="level">Level {{ level }}</option>
                }
              </select>
              }

              <!-- Delete only for newly added skills -->
              @if (isCoreEditing && skill.isNew) {
              <button class="btn-outline border-red-300 text-red-500 hover:bg-red-500 hover:text-white"
                (click)="removeCoreSkill(skill)">
                Remove
              </button>
              }
            </div>
            }

            <!-- Add Skill Button -->
            @if (isCoreEditing) {
            <div>
              <button class="btn-outline" (click)="addCoreSkill()">
                Add Core Skill
              </button>
            </div>
            }
          </div>
        </div>
        }

        <!-- TDC Skills -->
        @if (tdcSkills.length > 0) {
        <div class="grid gap-2 bg-white p-4 rounded-lg shadow-sm">
          <div class="flex justify-between items-center border-b border-gray-300 pb-2">
            <h3 class="text-lg font-bold text-gray-700">Skill Gaps (Technical & Domain Competency)</h3>
            <button class="btn-outline btn-sm" (click)="toggleTdcEdit()">
              {{ isTdcEditing ? 'Update' : 'Edit' }}
            </button>
          </div>

          <div class="grid gap-2">
            @for (skill of tdcSkills; track skill.tdcSkill) {
            <div class="grid grid-cols-[1fr_150px_auto] gap-2 items-stretch bg-white rounded-lg">

              <span [attr.contenteditable]="isTdcEditing ? 'true' : null" 
                [attr.oldValue]="skill.oldValue" class="block"
                (blur)="onTdcSkillChange(skill, $event);skill.isEdited = true">
                {{ skill.tdcSkill }}
              </span>

              @if (isTdcEditing) {
              <select [(ngModel)]="skill.tdcProficiencyLevel" class="form-select"
                (change)="onTdcProficiencyChange(skill)">
                @for (level of ['Basic', 'Intermediate', 'Advanced']; track level) {
                <option [value]="level" [selected]="level === 'Basic'">
                  {{ level }}
                </option>
                }
              </select>
              }

              <!-- Delete only for newly added skills -->
              @if (isTdcEditing && skill.isNew) {
              <button class="btn-outline border-red-300 text-red-500 hover:bg-red-500 hover:text-white"
                (click)="removeTdcSkill(skill)">
                Remove
              </button>
              }
            </div>
            }

            <!-- Add Skill Button -->
            @if (isTdcEditing) {
            <div>
              <button class="btn-outline" (click)="addTdcSkill()">
                Add Technical Skill
              </button>
            </div>
            }
          </div>
        </div>
        }

        <div>
          <button type="button" (click)="onSubmitKeyTaskChanges()" class="btn-primary">SAVE</button>
        </div>

      </section>
      }
    </section>
  }

  @if(showSkillSettings) {
    <section class="page-content">
      <!-- Add Sector / Track / Role Form -->
      <app-add-sector-track-role [tenantlist]="tenantlist" (added)="onRoleAdded($event)"
        (cancelled)="onChildCancelled()" [selectedTenantId]="selectedTenantId">
      </app-add-sector-track-role>
    </section>
  }
</div>